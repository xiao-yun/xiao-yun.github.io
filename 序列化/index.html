<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Common,Hadoop-1.2.1," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Hadoop版本:Hadoop-1.2.1参考：《Hadoop技术内幕-深入解析Hadoop Common和HDFS架构设计与实现原理》
序列化作用:

作为一种持久化格式，可以存储在磁盘上，可以用来反序列化；
作为通信数据格式，在网络上传输；
作为一种拷贝，克隆机制，对象序列化到内存缓存区中，然后反序列化得到一个对已存对象进行深拷贝的新对象；

JAVA中的序列化JAVA中类的序列化只需要实现S">
<meta property="og:type" content="article">
<meta property="og:title" content="Common源码阅读---序列化">
<meta property="og:url" content="http://xiao-yun.github.io/序列化/index.html">
<meta property="og:site_name" content="xiaoyun">
<meta property="og:description" content="Hadoop版本:Hadoop-1.2.1参考：《Hadoop技术内幕-深入解析Hadoop Common和HDFS架构设计与实现原理》
序列化作用:

作为一种持久化格式，可以存储在磁盘上，可以用来反序列化；
作为通信数据格式，在网络上传输；
作为一种拷贝，克隆机制，对象序列化到内存缓存区中，然后反序列化得到一个对已存对象进行深拷贝的新对象；

JAVA中的序列化JAVA中类的序列化只需要实现S">
<meta property="og:image" content="http://xiao-yun.github.io/../images/WritableComparable.png">
<meta property="og:image" content="http://xiao-yun.github.io/../images/WritableComparator.png">
<meta property="og:updated_time" content="2015-12-28T03:19:25.445Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Common源码阅读---序列化">
<meta name="twitter:description" content="Hadoop版本:Hadoop-1.2.1参考：《Hadoop技术内幕-深入解析Hadoop Common和HDFS架构设计与实现原理》
序列化作用:

作为一种持久化格式，可以存储在磁盘上，可以用来反序列化；
作为通信数据格式，在网络上传输；
作为一种拷贝，克隆机制，对象序列化到内存缓存区中，然后反序列化得到一个对已存对象进行深拷贝的新对象；

JAVA中的序列化JAVA中类的序列化只需要实现S">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide',
    motion: true
  };
</script>

  <title> Common源码阅读---序列化 | xiaoyun </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?caeb4129c91d1e6fb3d562d35fedef0d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">xiaoyun</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Common源码阅读---序列化
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-28T11:19:25+08:00" content="2015-12-28">
              2015-12-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Hadoop-1-2-1/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop-1.2.1</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Hadoop-1-2-1/Common/" itemprop="url" rel="index">
                    <span itemprop="name">Common</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Hadoop-1-2-1/Common/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/序列化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="序列化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>Hadoop版本:<a href="https://archive.apache.org/dist/hadoop/core/hadoop-1.2.1/" target="_blank" rel="external">Hadoop-1.2.1</a><br>参考：《Hadoop技术内幕-深入解析Hadoop Common和HDFS架构设计与实现原理》</p>
<p><strong>序列化作用:</strong></p>
<ul>
<li>作为一种持久化格式，可以存储在磁盘上，可以用来反序列化；</li>
<li>作为通信数据格式，在网络上传输；</li>
<li>作为一种拷贝，克隆机制，对象序列化到内存缓存区中，然后反序列化得到一个对已存对象进行深拷贝的新对象；</li>
</ul>
<h2 id="JAVA中的序列化">JAVA中的序列化</h2><p>JAVA中类的序列化只需要实现Serializable接口,该接口只是一个说明性的接口，没有实际的方法。<br>序列化实现通过一对输入/输出流，序列化时在某种OutputStream对象的基础上创建一个ObjectOutputStream对象，然后调用writeObject执行序列化。<br>输出的序列化数据将保存在原来的OutputStream中，具体序列化的数据由writeObject方法负责。<br>对于Java基本类型的序列化，ObjectOutputStream提供了writeBoolean，writeByte等方法。<br>而反序列化的过程类似，将InputStream包装在ObjectInputStream中并调用readObject方法，返回一个Object类型的引用，通过向下转型，可以得到正确的结果。  </p>
<p>JAVA序列化以后的对象所占数据过大，包括了很多与该对象相关联的信息，不过可以处理操作系统的差异，在Windows上序列化的对象，可以在UNIX上重建。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class <span class="type">ClassA</span> implements <span class="type">Serializable</span><span class="decorator">&#123;...&#125;</span></span><br><span class="line"><span class="type">ClassA</span> a=new <span class="type">ClassA</span>...;//实现<span class="type">Serializable</span>的类</span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="keyword">out</span>=new <span class="type">ByteArrayOutputStream</span>();//最终序列化结果输出到该流中</span><br><span class="line"><span class="type">ObjectOutputStream</span> objOut=new <span class="type">ObjectOutputStream</span>(<span class="keyword">out</span>);//包裹<span class="keyword">out</span>创建<span class="type">ObjectOutputStream</span></span><br><span class="line">objOut.writeObject(a);//序列化</span><br></pre></td></tr></table></figure></p>
<p>可以看出实际的序列化过程是ObjectOutputStream的writeObject完成的，格式固定</p>
<h2 id="Hadoop的序列化">Hadoop的序列化</h2><p>Hadoop没有采用Java的序列化机制，引入了<code>Writable</code>接口，作为所有可序列化对象必须实现的接口。该接口不是声明性的接口，包含两个方法：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Writable</span> &#123;</span><br><span class="line">  <span class="comment">//序列化，结果写到实现了DataOutput接口的类中(流)</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">write</span>(<span class="params">DataOutput <span class="keyword">out</span></span>) throws IOException</span>;</span><br><span class="line">  <span class="comment">//反序列化，从DataInput中读取</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">readFields</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如HDFS中的Block类，实现了Writable接口<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Block</span> <span class="keyword">implements</span> <span class="title">Writable</span>, <span class="title">Comparable</span>&lt;<span class="title">Block</span>&gt; &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="typename">long</span> blockId;</span><br><span class="line">    <span class="keyword">private</span> <span class="typename">long</span> numBytes;</span><br><span class="line">    <span class="keyword">private</span> <span class="typename">long</span> generationStamp;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="typename">void</span> write(DataOutput out) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      out.writeLong(blockId);</span><br><span class="line">      out.writeLong(numBytes);</span><br><span class="line">      out.writeLong(generationStamp);</span><br><span class="line">    &#125;<span class="comment">//分别将三个成员写到输出流中</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="typename">void</span> readFields(DataInput <span class="keyword">in</span>) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">this</span>.blockId = <span class="keyword">in</span>.readLong();</span><br><span class="line">        <span class="keyword">this</span>.numBytes = <span class="keyword">in</span>.readLong();</span><br><span class="line">        <span class="keyword">this</span>.generationStamp = <span class="keyword">in</span>.readLong();</span><br><span class="line">        <span class="keyword">if</span> (numBytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected block size: "</span> + numBytes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//从输入流中依次读取三个成员</span></span><br></pre></td></tr></table></figure></p>
<p>那么，我们可以像下面这样对Block进行序列化操作<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Block</span> <span class="keyword">block</span>=<span class="keyword">new</span> <span class="keyword">Block</span>(...);</span><br><span class="line">ByteArrrayOutputStream <span class="keyword">out</span>=<span class="keyword">new</span> ByteArrayOutputStream();<span class="comment">//最终输出到的流</span></span><br><span class="line">DataOutputStream data=<span class="keyword">new</span> DataOutputStream(<span class="keyword">out</span>);<span class="comment">//DataOutputStream，包裹out</span></span><br><span class="line"><span class="keyword">block</span>.<span class="keyword">write</span>(data);<span class="comment">//序列化</span></span><br><span class="line">dout.close();</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>可见，这里具体的序列化需要我们自己实现，自己指定那些需要写到输出流中。  </p>
<h2 id="WritableComparable">WritableComparable</h2><p><code>WritableComparable</code>提供了序列化功能的同时，还提供了比较功能，该接口在Hadoop中使用很频繁。<br>子类如Java基本类(IntWritable，FloatWritable，LongWritable等，VIntWritable,VLongWritable等变长基本类型)，Text等,还包括MapReduce<br>中用到的ID,TaskID,JobID等都需要序列化网络传输同时在需要排序时进行比较<br><img src="../images/WritableComparable.png" alt="WritableComparable">  </p>
<h3 id="NullWritable">NullWritable</h3><p><code>NullWritable</code>对应null，没有公有的构造函数，只能通过静态成员函数get来获取一个NullWritable对象,即所谓的单例模式<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class NullWritable implements WritableComparable &#123;</span><br><span class="line"> <span class="keyword"> private</span><span class="keyword"> static</span><span class="keyword"> final</span> NullWritable THIS =<span class="instruction"> new </span>NullWritable(<span class="function">)</span>;</span><br><span class="line"> <span class="keyword"> private</span><span class="function"> NullWritable(</span><span class="function">)</span> &#123;&#125;                       // no<span class="keyword"> public</span> ctor</span><br><span class="line">  /** Returns the single<span class="instruction"> instance </span>of this class. */</span><br><span class="line"> <span class="keyword"> public</span><span class="keyword"> static</span> NullWritable<span class="function"> get(</span><span class="function">)</span> &#123;<span class="instruction"> return </span>THIS; &#125;</span><br></pre></td></tr></table></figure></p>
<p>因为其对应的是null，因此<code>hashCode</code>为0，<code>toString</code>返回”null”，<code>compareTo</code>方法只能和另一个NullWritable对象比较，正常情况返回0。<br>相应的序列化反序列化方法<code>write</code>和<code>readFields</code>全都没有相应的操作。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"(null)"</span>;</span><br><span class="line">&#125;<span class="comment">//字符串null</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;<span class="comment">//hash码为0</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(other <span class="keyword">instanceof</span> NullWritable)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(<span class="string">"can't compare "</span> + other.getClass().getName() </span><br><span class="line">                                   + <span class="string">" to NullWritable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//只有在比较的对象为NullWritable时才返回0，不能与非NullWritable对象比较</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123; <span class="keyword">return</span> other <span class="keyword">instanceof</span> NullWritable; &#125;<span class="comment">//NullWritable对象相等，单例</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;&#125;<span class="comment">//空操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;&#125;<span class="comment">//空操作</span></span><br></pre></td></tr></table></figure></p>
<p>在静态代码段中，注册该类的WritableComparator<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;                                        <span class="comment">// register this comparator</span></span><br><span class="line">    WritableComparator.define(NullWritable.<span class="keyword">class</span>, <span class="keyword">new</span> Comparator());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Comparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span> Comparator() &#123;</span><br><span class="line">      <span class="keyword">super</span>(NullWritable.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Compare the buffers in serialized form.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="typename">int</span> compare(<span class="typename">byte</span>[] b1, <span class="typename">int</span> s1, <span class="typename">int</span> l1,</span><br><span class="line">                       <span class="typename">byte</span>[] b2, <span class="typename">int</span> s2, <span class="typename">int</span> l2) &#123;</span><br><span class="line">      <span class="keyword">assert</span> <span class="number">0</span> == l1;<span class="comment">//长度为0</span></span><br><span class="line">      <span class="keyword">assert</span> <span class="number">0</span> == l2;<span class="comment">//长度为0</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//和compareTo一样，正常情况只会返回0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ByteWritable">ByteWritable</h3><p>对应一个字节,成员<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure></p>
<p>序列化和反序列化<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException </span>&#123;</span><br><span class="line">    <span class="keyword">value</span> = <span class="keyword">in</span>.readByte();</span><br><span class="line">&#125;<span class="comment">//反序列化，从DataInput中读取一个字节</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span>(<span class="params">DataOutput <span class="keyword">out</span></span>) throws IOException </span>&#123;</span><br><span class="line">    <span class="keyword">out</span>.writeByte(<span class="keyword">value</span>);</span><br><span class="line">&#125;<span class="comment">//序列化</span></span><br></pre></td></tr></table></figure></p>
<p>ByteWritable之间比较<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> thisValue = <span class="keyword">this</span>.value;</span><br><span class="line">    <span class="keyword">int</span> thatValue = ((ByteWritable)o).value;</span><br><span class="line">    <span class="keyword">return</span> (thisValue &lt; thatValue ? -<span class="number">1</span> : (thisValue == thatValue ? <span class="number">0</span> : <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>toString</code>方法<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Byte.<span class="title">toString</span><span class="params">(value)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>静态代码段中的注册<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;                                        <span class="comment">// register this comparator</span></span><br><span class="line">    WritableComparator.define(ByteWritable.<span class="keyword">class</span>, <span class="keyword">new</span> Comparator());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Comparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span> Comparator() &#123;</span><br><span class="line">      <span class="keyword">super</span>(ByteWritable.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="typename">int</span> compare(<span class="typename">byte</span>[] b1, <span class="typename">int</span> s1, <span class="typename">int</span> l1, <span class="typename">byte</span>[] b2, <span class="typename">int</span> s2, <span class="typename">int</span> l2) &#123;</span><br><span class="line">      <span class="typename">byte</span> thisValue = b1[s1];</span><br><span class="line">      <span class="typename">byte</span> thatValue = b2[s2];</span><br><span class="line">      <span class="keyword">return</span> (thisValue &lt; thatValue ? -1 : (thisValue == thatValue ? 0 : <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他的如IntWritable，LongWritable等整型的基本一样，只不过相应的读取4个字节，8个字节。<br>而浮点型Float的读取4个字节整型，然后转换为浮点型<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Float</span><span class="class">.intBitsToFloat</span>(<span class="function">readInt</span>(bytes, start));</span><br></pre></td></tr></table></figure></p>
<p>浮点型Double的读取8个字节整型，转换为浮点型<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">return</span> Double.longBitsToDouble(<span class="built_in">read</span>Long(bytes, start));</span><br></pre></td></tr></table></figure></p>
<h3 id="变长基本类型VIntWritable，VLongWritable">变长基本类型VIntWritable，VLongWritable</h3><p>变长类型对实际数值比较小的整型，尽可能采用小的字节数序列化，更省空间。<br>主要看序列化和反序列化方法</p>
<h4 id="序列化">序列化</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//VInt</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span>(<span class="params">DataOutput <span class="keyword">out</span></span>) throws IOException </span>&#123; WritableUtils.writeVInt(<span class="keyword">out</span>, <span class="keyword">value</span>); &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeVInt</span>(<span class="params">DataOutput stream, <span class="keyword">int</span> i</span>) throws IOException </span>&#123; writeVLong(stream, i); &#125;</span><br><span class="line"><span class="comment">//VLong</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span>(<span class="params">DataOutput <span class="keyword">out</span></span>) throws IOException </span>&#123; WritableUtils.writeVLong(<span class="keyword">out</span>, <span class="keyword">value</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>可见最终是通过writeVLong方法进行序列化。该方法使用零压缩编码方法序列化一个long型整型到二进制流中。<br>对于[-112,127]范围内的数据，序列化只需要使用1个字节。<br>而对于其他值，序列化时第一个字节显示该long型数值是正还是负，且显示了序列化该数值所用的字节数。<br>如果第一个字节v在[-120,-113]范围内，则该long型数值为正，字节数n为-(v+112)。<br>如果第一个字节v在[-128,-121]范围内，则该long型数值为负，字节数n为-(v+120)。<br>接下来的n个字节为该long型数值的序列化字节，使用高位非零字节在前的顺序(即高位的全0字节不序列化)。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeVLong</span><span class="params">(DataOutput stream, <span class="keyword">long</span> i)</span> throws IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= -<span class="number">112</span> &amp;&amp; i &lt;= <span class="number">127</span>) &#123;<span class="comment">//一个字节便可表示</span></span><br><span class="line">      stream.writeByte((byte)i);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> len = -<span class="number">112</span>;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      i ^= -<span class="number">1L</span>; <span class="comment">// take one's complement'</span></span><br><span class="line">      len = -<span class="number">120</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">long</span> tmp = i;</span><br><span class="line">    <span class="keyword">while</span> (tmp != <span class="number">0</span>) &#123;</span><br><span class="line">      tmp = tmp &gt;&gt; <span class="number">8</span>;</span><br><span class="line">      len--;</span><br><span class="line">    &#125;<span class="comment">//此时，len值保存了该long型数值的正负性和所需字节数信息</span></span><br><span class="line">  </span><br><span class="line">    stream.writeByte((byte)len);<span class="comment">//输出len值</span></span><br><span class="line">  </span><br><span class="line">    len = (len &lt; -<span class="number">120</span>) ? -(len + <span class="number">120</span>) : -(len + <span class="number">112</span>);<span class="comment">//实际所需字节数据</span></span><br><span class="line">    <span class="comment">//输出序列化字节</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> idx = len; idx != <span class="number">0</span>; idx--) &#123;</span><br><span class="line">      <span class="keyword">int</span> shiftbits = (idx - <span class="number">1</span>) * <span class="number">8</span>;</span><br><span class="line">      <span class="keyword">long</span> mask = <span class="number">0xFF</span>L &lt;&lt; shiftbits;</span><br><span class="line">      stream.writeByte((byte)((i &amp; mask) &gt;&gt; shiftbits));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="反序列化">反序列化</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//VInt</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException </span>&#123; <span class="keyword">value</span> = WritableUtils.readVInt(<span class="keyword">in</span>); &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">readVInt</span>(<span class="params">DataInput stream</span>) throws IOException </span>&#123; <span class="keyword">return</span> (<span class="keyword">int</span>) readVLong(stream); &#125;</span><br><span class="line"><span class="comment">//VLong</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException </span>&#123; <span class="keyword">value</span> = WritableUtils.readVLong(<span class="keyword">in</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>readVLong</code>反序列化<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">readVLong</span><span class="params">(DataInput stream)</span> throws IOException </span>&#123;</span><br><span class="line">    byte firstByte = stream.readByte();<span class="comment">//读第一个字节</span></span><br><span class="line">    <span class="keyword">int</span> len = decodeVIntSize(firstByte);<span class="comment">//序列化字节长度</span></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">1</span>) &#123;<span class="comment">//序列化一个字节</span></span><br><span class="line">      <span class="keyword">return</span> firstByte;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//序列化为多个字节，分别读取</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; len-<span class="number">1</span>; idx++) &#123;</span><br><span class="line">      byte b = stream.readByte();</span><br><span class="line">      i = i &lt;&lt; <span class="number">8</span>;</span><br><span class="line">      i = i | (b &amp; <span class="number">0xFF</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (isNegativeVInt(firstByte) ? (i ^ -<span class="number">1L</span>) : i);<span class="comment">//正负极性</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decodeVIntSize</span><span class="params">(byte value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= -<span class="number">112</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &lt; -<span class="number">120</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> -<span class="number">119</span> - value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">111</span> - value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据序列化过程，很简单得到反序列化过程。<code>decodeVIntSize</code>根据第一个字节得到序列化字节的长度。</p>
<h3 id="Text">Text</h3><p>使用标准的UTF8编码存储文本，提供对文本字节级别的序列化，反序列化和比较等方法。还提供在不将字节数组转换为字符串的情况下的字符串反转。<br>也包括了序列化/反序列化一个字符串，编码/解码一个字符串，检查一个字节数组是否包含合法的UTF8编码，计算一个已经编码过字符串的长度等工具方法。  </p>
<h4 id="成员">成员</h4><p>包括两个线程独立的编码工厂<code>ENCODER_FACTORY</code>和解码工厂<code>DECODER_FACTORY</code><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;CharsetEncoder&gt; ENCODER_FACTORY =</span><br><span class="line"><span class="keyword">new</span> ThreadLocal&lt;CharsetEncoder&gt;() &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="function">CharsetEncoder <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Charset.forName(<span class="string">"UTF-8"</span>).newEncoder().</span><br><span class="line">           onMalformedInput(CodingErrorAction.REPORT).</span><br><span class="line">           onUnmappableCharacter(CodingErrorAction.REPORT);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;<span class="comment">//编码工厂</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;CharsetDecoder&gt; DECODER_FACTORY =</span><br><span class="line"><span class="keyword">new</span> ThreadLocal&lt;CharsetDecoder&gt;() &#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="function">CharsetDecoder <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Charset.forName(<span class="string">"UTF-8"</span>).newDecoder().</span><br><span class="line">         onMalformedInput(CodingErrorAction.REPORT).</span><br><span class="line">         onUnmappableCharacter(CodingErrorAction.REPORT);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;<span class="comment">//解码工厂</span></span><br></pre></td></tr></table></figure></p>
<p>使用字节数组存储文本数据，并记录长度<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> [] EMPTY_BYTES = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];<span class="comment">//默认构造</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] bytes;<span class="comment">//存储字节级别数据</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> length;<span class="comment">//长度</span></span><br></pre></td></tr></table></figure></p>
<h4 id="编解码">编解码</h4><ul>
<li><p>编码(文本或字符串转字节数组)</p>
  <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">encode</span>(<span class="params">String <span class="keyword">string</span></span>) throws CharacterCodingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> encode(<span class="keyword">string</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">encode</span>(<span class="params">String <span class="keyword">string</span>, boolean replace</span>) throws CharacterCodingException </span>&#123;</span><br><span class="line">    CharsetEncoder encoder = ENCODER_FACTORY.<span class="keyword">get</span>();<span class="comment">//编码工厂获取字符集编码器CharsetEncoder</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;<span class="comment">//如果支持替换，则异常输入被替换为"U+FFFD",这里设置异常输入和未映射的字符支持替换</span></span><br><span class="line">      encoder.onMalformedInput(CodingErrorAction.REPLACE);</span><br><span class="line">      encoder.onUnmappableCharacter(CodingErrorAction.REPLACE);</span><br><span class="line">    &#125;</span><br><span class="line">    ByteBuffer bytes = encoder.encode(CharBuffer.wrap(<span class="keyword">string</span>.toCharArray()));<span class="comment">//编码器编码</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;<span class="comment">//支持替换的话，编码后设置编码器为原来默认采用"报告"形式</span></span><br><span class="line">      encoder.onMalformedInput(CodingErrorAction.REPORT);</span><br><span class="line">      encoder.onUnmappableCharacter(CodingErrorAction.REPORT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解码(字节数组转字符串)</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> decode(<span class="built_in">byte</span>[] utf8) <span class="keyword">throws</span> CharacterCodingException &#123; <span class="keyword">return</span> decode(ByteBuffer.wrap(utf8), <span class="keyword">true</span>); &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> decode(<span class="built_in">byte</span>[] utf8, <span class="built_in">int</span> start, <span class="built_in">int</span> length) <span class="keyword">throws</span> CharacterCodingException &#123;</span><br><span class="line">    <span class="keyword">return</span> decode(ByteBuffer.wrap(utf8, start, length), <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> decode(ByteBuffer utf8, <span class="built_in">boolean</span> replace) <span class="keyword">throws</span> CharacterCodingException &#123;</span><br><span class="line">    CharsetDecoder decoder = DECODER_FACTORY.<span class="built_in">get</span>();<span class="comment">//解码器工厂获得字符集解码器</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;<span class="comment">//同编码过程一样，支持replace的话，异常输入和未映射的字符替换为"U+FFFD"。</span></span><br><span class="line">      decoder.onMalformedInput(java.nio.charset.CodingErrorAction.REPLACE);</span><br><span class="line">      decoder.onUnmappableCharacter(CodingErrorAction.REPLACE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">String</span> <span class="built_in">str</span> = decoder.decode(utf8).toString();<span class="comment">//解码</span></span><br><span class="line">    <span class="comment">// set decoder back to its default value: REPORT</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;<span class="comment">//支持replace时，重新设置为REPORT</span></span><br><span class="line">      decoder.onMalformedInput(CodingErrorAction.REPORT);</span><br><span class="line">      decoder.onUnmappableCharacter(CodingErrorAction.REPORT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="构造">构造</h4><ul>
<li><p>缺省构造<br>  缺省构造方法，创建空字节数组</p>
  <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Text</span><span class="params">()</span> </span>&#123; bytes = EMPTY_BYTES; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过String构造</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Text</span><span class="params">(String <span class="built_in">string</span>)</span> </span>&#123; <span class="built_in">set</span>(<span class="built_in">string</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String <span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ByteBuffer bb = encode(<span class="built_in">string</span>, <span class="literal">true</span>);<span class="comment">//编码成ByteBuffer</span></span><br><span class="line">      bytes = bb.<span class="built_in">array</span>();</span><br><span class="line">      length = bb.limit();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(CharacterCodingException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should not have happened "</span> + e.toString()); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  给定一个String，将String转为char数组，包裹成CharBuffer，通过NIO的CharsetEncoder进行编码，编码器通过线程独立静态成员ENCODER_FACTORY<br>  获得。关于ByteBuffer或CharBuffer另见<a href="../缓冲区">NIO缓冲区</a></p>
</li>
<li><p>从其他Text构造</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Text</span><span class="params">(Text utf8)</span> </span>&#123; <span class="built_in">set</span>(utf8); &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Text other)</span> </span>&#123; <span class="built_in">set</span>(other.getBytes(), <span class="number">0</span>, other.getLength()); &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(byte[] utf8, <span class="keyword">int</span> start, <span class="keyword">int</span> len)</span> </span>&#123;<span class="comment">//简单的将其他Text字节数组进行拷贝</span></span><br><span class="line">    setCapacity(len, <span class="literal">false</span>);</span><br><span class="line">    System.arraycopy(utf8, start, bytes, <span class="number">0</span>, len);</span><br><span class="line">    <span class="keyword">this</span>.length = len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接从字节数组构造</p>
  <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Text</span>(<span class="params"><span class="keyword">byte</span>[] utf8</span>)  </span>&#123; <span class="keyword">set</span>(utf8); &#125;<span class="comment">//简单拷贝</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="数据操作">数据操作</h4><ul>
<li><p>数组容量变更</p>
  <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//len小于当前字节数组长度无需改变，否则重新分配一个新的字节数组，并根据keepData决定是否保持原来字节数组的数据，保持的话拷贝原来数据</span></span><br><span class="line"><span class="comment">//到新的字节缓冲中</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">setCapacity</span><span class="params">(<span class="keyword">int</span> len, <span class="keyword">boolean</span> keepData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="keyword">null</span> || bytes.length &lt; len) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] newBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">      <span class="keyword">if</span> (bytes != <span class="keyword">null</span> &amp;&amp; keepData) &#123;</span><br><span class="line">        System.arraycopy(bytes, <span class="number">0</span>, newBytes, <span class="number">0</span>, length);</span><br><span class="line">      &#125;</span><br><span class="line">      bytes = newBytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据追加</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void <span class="built_in">append</span>(<span class="typename">byte</span>[] utf8, <span class="typename">int</span> start, <span class="typename">int</span> <span class="built_in">len</span>) &#123;</span><br><span class="line">    setCapacity(length + <span class="built_in">len</span>, <span class="constant">true</span>);</span><br><span class="line">    System.arraycopy(utf8, start, bytes, length, <span class="built_in">len</span>);</span><br><span class="line">    length += <span class="built_in">len</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  utf8数组从start位置长度为len的数据追加到字节数组中</p>
</li>
<li><p>数据清除</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123; length = <span class="number">0</span>; &#125;<span class="comment">//简单的将长度置为0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>转字符串</p>
  <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">return</span> <span class="title">decode</span><span class="params">(bytes, <span class="number">0</span>, length)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CharacterCodingException e) &#123; </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should not have happened "</span> + e.toString()); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  字节数组转字符串对应解码过程，过程如上。其中的ByteBuffer和CharBuffer另见<a href="../缓冲区">NIO缓冲区</a>。  </p>
</li>
<li><p>其他<br>  验证字节数组是否为标准UTF8格式</p>
  <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">validateUTF8</span><span class="params">(<span class="keyword">byte</span>[] utf8)</span> <span class="keyword">throws</span> MalformedInputException </span>&#123;</span><br><span class="line">    validateUTF8(utf8, <span class="number">0</span>, utf8.length);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  给定一个字符串，计算该字符串对应UTF8对应字节长度  </p>
  <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="built_in">int</span> utf8Length(<span class="built_in">String</span> <span class="built_in">string</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="序列化/反序列化">序列化/反序列化</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span>(<span class="params">DataOutput <span class="keyword">out</span></span>) throws IOException </span>&#123;</span><br><span class="line">    WritableUtils.writeVInt(<span class="keyword">out</span>, length);<span class="comment">//先输出长度</span></span><br><span class="line">    <span class="keyword">out</span>.write(bytes, <span class="number">0</span>, length);<span class="comment">//写字节数组数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newLength = WritableUtils.readVInt(<span class="keyword">in</span>);<span class="comment">//读字节数组长度</span></span><br><span class="line">    setCapacity(newLength, <span class="keyword">false</span>);<span class="comment">//设置容量(可能扩充)</span></span><br><span class="line">    <span class="keyword">in</span>.readFully(bytes, <span class="number">0</span>, newLength);<span class="comment">//读字节数组数据</span></span><br><span class="line">    length = newLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>序列化时，先输出可变长度int型的长度length，然后输出字节数组数据。反序列化时，同样的先读字节数组长度，设置容量(不保存原来数据)，然后读字节数组数据。  </p>
<h4 id="其他一些高阶的序列化/反序列化操作">其他一些高阶的序列化/反序列化操作</h4><ul>
<li><p>从流中读字符串</p>
  <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readString</span>(<span class="params">DataInput <span class="keyword">in</span></span>) throws IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = WritableUtils.readVInt(<span class="keyword">in</span>);<span class="comment">//读取字符串长度</span></span><br><span class="line">    <span class="keyword">byte</span> [] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">    <span class="keyword">in</span>.readFully(bytes, <span class="number">0</span>, length);<span class="comment">//读取字符串字节数据</span></span><br><span class="line">    <span class="keyword">return</span> decode(bytes);<span class="comment">//解码，字节数组转换为字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串的序列化输出</p>
  <figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static <span class="keyword">int</span> writeString(DataOutput <span class="keyword">out</span>, String s) throws IOException &#123;</span><br><span class="line">  ByteBuffer bytes = encode(s);<span class="comment">//字符串编码为ByteBuffer</span></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">length</span> = bytes.limit();</span><br><span class="line">  WritableUtils.writeVInt(<span class="keyword">out</span>, <span class="built_in">length</span>);</span><br><span class="line">  <span class="keyword">out</span>.write(bytes.array(), <span class="number">0</span>, <span class="built_in">length</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">length</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="比较">比较</h4><p>注册比较器<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// register this comparator</span></span><br><span class="line">    WritableComparator.define(Text.class, <span class="keyword">new</span> Comparator());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Comparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Comparator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(Text.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">byte</span>[] b1, <span class="keyword">int</span> s1, <span class="keyword">int</span> l1,</span><br><span class="line">                       <span class="keyword">byte</span>[] b2, <span class="keyword">int</span> s2, <span class="keyword">int</span> l2)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> n1 = WritableUtils.decodeVIntSize(b1[s1]);<span class="comment">//n1为第一个Text length字段所占字节数</span></span><br><span class="line">      <span class="keyword">int</span> n2 = WritableUtils.decodeVIntSize(b2[s2]);<span class="comment">//n2为第二个Text length字段所占字节数</span></span><br><span class="line">      <span class="function"><span class="keyword">return</span> <span class="title">compareBytes</span><span class="params">(b1, s1+n1, l1-n1, b2, s2+n2, l2-n2)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Text的比较器直接支持字节级别的比较，不需要反序列化为Text进行比较。序列化时，先写长度，且长度是通过可变长度的方式序列化的，因此从读取的第一个<br>字节获取长度字段所占字节数。<code>compareBytes</code>为WritableComparator这父类中的方法，字节级别的比较。</p>
<h4 id="ObjectWritable">ObjectWritable</h4><p>ObjectWritable针对基本类型,字符串(Text)，空值(NullWritable)等Writable的其他子类提供了封装，能够对封装在ObjectWritable中不同对象<br>进行不同处理，适用于字段需要使用多种类型。典型的应用于Hadoop远程过程调用参数的序列化和反序列化。    </p>
<h5 id="成员属性">成员属性</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">Class</span> declaredClass;<span class="comment">//被封装的类</span></span><br><span class="line"><span class="keyword">private</span> Object instance;<span class="comment">//被封装对象实例</span></span><br><span class="line"><span class="keyword">private</span> Configuration conf;<span class="comment">//配置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, <span class="keyword">Class</span>&lt;?&gt;&gt; PRIMITIVE_NAMES = <span class="keyword">new</span> HashMap&lt;String, <span class="keyword">Class</span>&lt;?&gt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"boolean"</span>, <span class="keyword">Boolean</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"byte"</span>, <span class="keyword">Byte</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"char"</span>, Character.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"short"</span>, <span class="keyword">Short</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"int"</span>, Integer.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"long"</span>, <span class="keyword">Long</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"float"</span>, <span class="keyword">Float</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"double"</span>, <span class="keyword">Double</span>.TYPE);</span><br><span class="line">    PRIMITIVE_NAMES.put(<span class="string">"void"</span>, <span class="keyword">Void</span>.TYPE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="序列化-1">序列化</h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public void write(DataOutput <span class="keyword">out</span>) throws IOException &#123;</span><br><span class="line">    writeObject(<span class="keyword">out</span>, instance, declaredClass, <span class="keyword">conf</span>);</span><br><span class="line">&#125;</span><br><span class="line">public static void writeObject(DataOutput <span class="keyword">out</span>, Object instance, <span class="keyword">Class</span> declaredClass, Configuration <span class="keyword">conf</span>) throws IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == null) &#123;                       <span class="comment">// null</span></span><br><span class="line">      instance = new NullInstance(declaredClass, <span class="keyword">conf</span>);</span><br><span class="line">      declaredClass = Writable.<span class="keyword">class</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UTF8.writeString(<span class="keyword">out</span>, declaredClass.getName()); <span class="comment">// always write declared</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (declaredClass.isArray()) &#123;                <span class="comment">// array</span></span><br><span class="line">      int length = Array.getLength(instance);</span><br><span class="line">      <span class="keyword">out</span>.writeInt(length);</span><br><span class="line">      <span class="keyword">for</span> (int i = 0; i &lt; length; i++) &#123;</span><br><span class="line">        writeObject(<span class="keyword">out</span>, Array.<span class="literal">get</span>(instance, i), declaredClass.getComponentType(), <span class="keyword">conf</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == String.<span class="keyword">class</span>) &#123;   <span class="comment">// String</span></span><br><span class="line">      UTF8.writeString(<span class="keyword">out</span>, (String)instance);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass.isPrimitive()) &#123;     <span class="comment">// primitive type</span></span><br><span class="line">      <span class="keyword">if</span> (declaredClass == Boolean.<span class="keyword">TYPE</span>) &#123;        <span class="comment">// boolean</span></span><br><span class="line">        <span class="keyword">out</span>.writeBoolean(((Boolean)instance).booleanValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Character.<span class="keyword">TYPE</span>) &#123; <span class="comment">// char</span></span><br><span class="line">        <span class="keyword">out</span>.writeChar(((Character)instance).charValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Byte.<span class="keyword">TYPE</span>) &#123;    <span class="comment">// byte</span></span><br><span class="line">        <span class="keyword">out</span>.writeByte(((Byte)instance).byteValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Short.<span class="keyword">TYPE</span>) &#123;   <span class="comment">// short</span></span><br><span class="line">        <span class="keyword">out</span>.writeShort(((Short)instance).shortValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Integer.<span class="keyword">TYPE</span>) &#123; <span class="comment">// int</span></span><br><span class="line">        <span class="keyword">out</span>.writeInt(((Integer)instance).intValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Long.<span class="keyword">TYPE</span>) &#123;    <span class="comment">// long</span></span><br><span class="line">        <span class="keyword">out</span>.writeLong(((Long)instance).longValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Float.<span class="keyword">TYPE</span>) &#123;   <span class="comment">// float</span></span><br><span class="line">        <span class="keyword">out</span>.writeFloat(((Float)instance).floatValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Double.<span class="keyword">TYPE</span>) &#123;  <span class="comment">// double</span></span><br><span class="line">        <span class="keyword">out</span>.writeDouble(((Double)instance).doubleValue());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass == Void.<span class="keyword">TYPE</span>) &#123;    <span class="comment">// void</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        throw new IllegalArgumentException(<span class="string">"Not a primitive: "</span>+declaredClass);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaredClass.isEnum()) &#123;         <span class="comment">// enum</span></span><br><span class="line">      UTF8.writeString(<span class="keyword">out</span>, ((Enum)instance).name());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Writable.<span class="keyword">class</span>.isAssignableFrom(declaredClass)) &#123; <span class="comment">// Writable</span></span><br><span class="line">      UTF8.writeString(<span class="keyword">out</span>, instance.getClass().getName());</span><br><span class="line">      ((Writable)instance).write(<span class="keyword">out</span>);</span><br><span class="line">    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      throw new IOException(<span class="string">"Can't write: "</span>+instance+<span class="string">" as "</span>+declaredClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>序列化时，每种类型都先写出<code>declaredClass</code>声明类的类名，然后对不同的类型输出不同内容:</p>
<ul>
<li>null,”NullInstance”+declaredClass名字.null会创建相应的NullWritable对象，作为Writable的子类，对应下面情况</li>
<li>数组，元素长度+每一个元素,每一个数组元素作为对象调用<code>writeObject</code>写出</li>
<li>String，字符串数据</li>
<li>Boolean，1字节数据(0或1)</li>
<li>Character，2字节数据</li>
<li>Byte，1字节数据</li>
<li>Short,2字节数据</li>
<li>Int，4字节数据</li>
<li>Long,8字节数据</li>
<li>Float，4字节数据</li>
<li>Double，8字节数据</li>
<li>Void,无后续输出(即只输出<code>declaredClass</code>名字)</li>
<li>Enum，枚举的name属性</li>
<li>Writable子类，实例对应的类名+该子类序列化方法write的输出，null也为这种情况<br>以上情况中，对于本原类型Boolean，Character，Byte，Short，Int，Long，Float，Double写出的字节数据都是通过DataOutput的相应方法write*<br>输出的。而对于Writable的子类还需输出实例对应的类名，因为declaredClass可能对应为其父类类名，然后通过自己的序列化方法写出实际数据。  </li>
</ul>
<h5 id="反序列化-1">反序列化</h5><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public void<span class="function"> readFields(</span>DataInput in<span class="function">)</span> throws IOException &#123;<span class="function"> readObject(</span>in, this, this.conf<span class="function">)</span>; &#125;</span><br><span class="line"><span class="keyword"></span><br><span class="line">public</span><span class="keyword"> static</span> Object<span class="function"> readObject(</span>DataInput in, ObjectWritable objectWritable, Configuration conf<span class="function">)</span></span><br><span class="line">throws IOException &#123;</span><br><span class="line">    String className =<span class="function"> UTF8.readString(</span>in<span class="function">)</span>;//读取declaredClass的类名</span><br><span class="line">    Class&lt;?&gt; declaredClass =<span class="function"> PRIMITIVE_NAMES.get(</span>className<span class="function">)</span>;</span><br><span class="line">   <span class="instruction"> if </span>(declaredClass == null<span class="function">)</span> &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        declaredClass =<span class="function"> conf.getClassByName(</span>className<span class="function">)</span>;</span><br><span class="line">      &#125; catch<span class="function"> (</span>ClassNotFoundException e<span class="function">)</span> &#123;</span><br><span class="line">       <span class="instruction"> throw </span>new<span class="function"> RuntimeException(</span><span class="string">"readObject can't find class "</span> + className, e<span class="function">)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">    Object instance;</span><br><span class="line">   <span class="instruction"> if </span>(declaredClass.isPrimitive(<span class="function">)</span><span class="function">)</span> &#123;            // primitive types</span><br><span class="line">     <span class="instruction"> if </span>(declaredClass == Boolean.TYPE<span class="function">)</span> &#123;             // boolean</span><br><span class="line">       <span class="instruction"> instance </span>=<span class="function"> Boolean.valueOf(</span>in.readBoolean(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Character.TYPE<span class="function">)</span> &#123;    // char</span><br><span class="line">       <span class="instruction"> instance </span>=<span class="function"> Character.valueOf(</span>in.readChar(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Byte.TYPE<span class="function">)</span> &#123;         // byte</span><br><span class="line">       <span class="instruction"> instance </span>=<span class="function"> Byte.valueOf(</span>in.readByte(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Short.TYPE<span class="function">)</span> &#123;        // short</span><br><span class="line">       <span class="instruction"> instance </span>=<span class="function"> Short.valueOf(</span>in.readShort(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Integer.TYPE<span class="function">)</span> &#123;      //<span class="instruction"> int</span><br><span class="line"></span>       <span class="instruction"> instance </span>=<span class="function"> Integer.valueOf(</span>in.readInt(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Long.TYPE<span class="function">)</span> &#123;         //<span class="instruction"> long</span><br><span class="line"></span>       <span class="instruction"> instance </span>=<span class="function"> Long.valueOf(</span>in.readLong(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Float.TYPE<span class="function">)</span> &#123;        //<span class="instruction"> float</span><br><span class="line"></span>       <span class="instruction"> instance </span>=<span class="function"> Float.valueOf(</span>in.readFloat(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Double.TYPE<span class="function">)</span> &#123;       //<span class="instruction"> double</span><br><span class="line"></span>       <span class="instruction"> instance </span>=<span class="function"> Double.valueOf(</span>in.readDouble(<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125; else<span class="instruction"> if </span>(declaredClass == Void.TYPE<span class="function">)</span> &#123;         // void</span><br><span class="line">       <span class="instruction"> instance </span>= null;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">       <span class="instruction"> throw </span>new<span class="function"> IllegalArgumentException(</span><span class="string">"Not a primitive: "</span>+declaredClass<span class="function">)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else<span class="instruction"> if </span>(declaredClass.isArray(<span class="function">)</span><span class="function">)</span> &#123;              //<span class="instruction"> array</span><br><span class="line"></span>     <span class="instruction"> int </span>length =<span class="function"> in.readInt(</span><span class="function">)</span>;</span><br><span class="line">     <span class="instruction"> instance </span>=<span class="function"> Array.newInstance(</span>declaredClass.getComponentType(<span class="function">)</span>, length<span class="function">)</span>;</span><br><span class="line">      for<span class="function"> (</span>int i = 0; i &lt; length; i++<span class="function">)</span> &#123;</span><br><span class="line">       <span class="function"> Array.set(</span>instance, i,<span class="function"> readObject(</span>in, conf<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else<span class="instruction"> if </span>(declaredClass == String.class<span class="function">)</span> &#123;        // String</span><br><span class="line">     <span class="instruction"> instance </span>=<span class="function"> UTF8.readString(</span>in<span class="function">)</span>;</span><br><span class="line">    &#125; else<span class="instruction"> if </span>(declaredClass.isEnum(<span class="function">)</span><span class="function">)</span> &#123;         // enum</span><br><span class="line">     <span class="instruction"> instance </span>=<span class="function"> Enum.valueOf(</span>(Class&lt;? extends Enum&gt;<span class="function">)</span> declaredClass,<span class="function"> UTF8.readString(</span>in<span class="function">)</span><span class="function">)</span>;</span><br><span class="line">    &#125; else &#123;                                      // Writable</span><br><span class="line">   <span class="function"> //Writable及其子类序列化时先写declaredClass名字，接着是实例名字，再然后是该Writable的序列化数据(</span>对null来说序列化数据为declaredClass<span class="function">)</span></span><br><span class="line">      Class instanceClass = null;</span><br><span class="line">      String str = <span class="string">""</span>;</span><br><span class="line">      try &#123;</span><br><span class="line">        str =<span class="function"> UTF8.readString(</span>in<span class="function">)</span>;</span><br><span class="line">        instanceClass =<span class="function"> conf.getClassByName(</span>str<span class="function">)</span>;</span><br><span class="line">      &#125; catch<span class="function"> (</span>ClassNotFoundException e<span class="function">)</span> &#123;</span><br><span class="line">       <span class="instruction"> throw </span>new<span class="function"> RuntimeException(</span><span class="string">"readObject can't find class "</span> + str, e<span class="function">)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Writable writable =<span class="function"> WritableFactories.newInstance(</span>instanceClass, conf<span class="function">)</span>;</span><br><span class="line">     <span class="function"> writable.readFields(</span>in<span class="function">)</span>;</span><br><span class="line">     <span class="instruction"> instance </span>= writable;</span><br><span class="line">     <span class="instruction"> if </span>(instanceClass == NullInstance.class<span class="function">)</span> &#123;  // null</span><br><span class="line">        declaredClass =<span class="function"> (</span>(NullInstance<span class="function">)</span>instance<span class="function">)</span>.declaredClass;</span><br><span class="line">       <span class="instruction"> instance </span>= null;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="instruction"> if </span>(objectWritable != null<span class="function">)</span> &#123;                 // store values</span><br><span class="line">      objectWritable.declaredClass = declaredClass;</span><br><span class="line">      objectWritable.instance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="instruction"> return </span>instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上，有了序列化过程，便很好理解。首先读取类名，得到相应的类。<br>如果是本原类型，则通过DataInput的read*方法获取相应字节的数据反序列化对象，对于是Void的，实例为null。<br>如果是数组，读取数组长度，然后通过Array.newInstance创建数组(数组类型已知)，接着便是通过readObject一个一个读数组元素对象。<br>如果是Writable子类，先读实例名，通过<code>WritableFactories</code>创建相应实例，然后相应实例readFields方法反序列化数据。null也对应此种情况，不过<br>null序列化时对应创建NullWritable，其序列化函数输出其declaredClass。  </p>
<p>WritableFactories拥有静态成员<code>CLASS_TO_FACTORY</code>，维护了所有可序列化类对应的工厂。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;<span class="keyword">Class</span>, WritableFactory&gt; CLASS_TO_FACTORY = <span class="keyword">new</span> HashMap&lt;<span class="keyword">Class</span>, WritableFactory&gt;();</span><br></pre></td></tr></table></figure></p>
<p>如果需要使用工厂创建相应类的实例，需注册类对应的工厂，工厂继承WritableFactory类实现newInstance的方法，WritableFactories的newInstance<br>方法如下:<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="type">Writable</span> newInstance(<span class="type">Class</span>&lt;? extends <span class="type">Writable</span>&gt; c, <span class="type">Configuration</span> conf) &#123;</span><br><span class="line">    <span class="type">WritableFactory</span> factory = <span class="type">WritableFactories</span>.getFactory(c);//该类注册了对应的工厂类</span><br><span class="line">    <span class="keyword">if</span> (factory != null) &#123;//注册了工厂类的话，使用工厂类的newInstance方法，因此注册时工厂类应该继承<span class="type">WritableFactory</span>类实现newInstance方法</span><br><span class="line">      <span class="type">Writable</span> <span class="literal">result</span> = factory.newInstance();//使用工厂类创建实例</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">result</span> instanceof <span class="type">Configurable</span>) &#123;//如果是可配置的，配置</span><br><span class="line">        ((<span class="type">Configurable</span>) <span class="literal">result</span>).setConf(conf);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;//没有对应的工厂类，使用反射创建实例</span><br><span class="line">      <span class="keyword">return</span> <span class="type">ReflectionUtils</span>.newInstance(c, conf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> synchronized <span class="type">WritableFactory</span> getFactory(<span class="type">Class</span> c) &#123; <span class="keyword">return</span> <span class="type">CLASS_TO_FACTORY</span>.get(c); &#125;</span><br></pre></td></tr></table></figure></p>
<p>注册工厂通过静态方法<code>setFactory</code><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">setFactory</span><span class="params">(Class c, WritableFactory factory)</span> </span>&#123; CLASS_TO_FACTORY.put(c, factory); &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="WritableComparator">WritableComparator</h2><p>WritableComparator为WritableComparable对应的比较器，类图如下:<br><img src="../images/WritableComparator.png" alt="序列化"><br><code>RawComparator</code>继承自<code>Comparator</code>比较器，提供了字节层面上的比较，即允许直接比较流中未被反序列化的对象，从而省去了创建对象的开销<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RawComparator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">byte</span>[] b1, <span class="keyword">int</span> s1, <span class="keyword">int</span> l1, <span class="keyword">byte</span>[] b2, <span class="keyword">int</span> s2, <span class="keyword">int</span> l2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而<code>WritableComparator</code>对应为<code>WritableComparable</code>的比较器，继承自RawComparator。不仅可以先反序列化流中数据，然后进行比较，同时提供了<br>直接读取流中数据进行比较的功能。</p>
<h3 id="成员-1">成员</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;<span class="keyword">Class</span>, WritableComparator&gt; comparators = <span class="keyword">new</span> HashMap&lt;<span class="keyword">Class</span>, WritableComparator&gt;(); <span class="comment">// registry</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> WritableComparable&gt; keyClass;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WritableComparable key1;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WritableComparable key2;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DataInputBuffer buffer;</span><br></pre></td></tr></table></figure>
<p>静态成员<code>comparators</code>维护了所有的”WritableComparable-WritableComparator”键值对,可通过<code>define</code>静态成员函数注册一个键值对<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">define</span><span class="params">(Class c, WritableComparator comparator)</span> </span>&#123;</span><br><span class="line">    comparators.put(c, comparator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>keyClass</code>为本对象对应的<code>WritableComparable</code>类<br><code>key1</code>,<code>key2</code>暂存反序列化的结果，用于比较<br><code>buffer</code>可重用的DataInput缓冲，实际存储数据的为byte数组(ByteArrayInputStream)  </p>
<h3 id="构造-1">构造</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">WritableComparator</span><span class="params">(Class&lt;? <span class="keyword">extends</span> WritableComparable&gt; keyClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(keyClass, <span class="keyword">false</span>);<span class="comment">//默认不创建成员实例</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">WritableComparator</span><span class="params">(Class&lt;? <span class="keyword">extends</span> WritableComparable&gt; keyClass, <span class="keyword">boolean</span> createInstances)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.keyClass = keyClass;</span><br><span class="line">    <span class="keyword">if</span> (createInstances) &#123;</span><br><span class="line">      key1 = newKey();</span><br><span class="line">      key2 = newKey();</span><br><span class="line">      buffer = <span class="keyword">new</span> DataInputBuffer();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//默认</span></span><br><span class="line">      key1 = key2 = <span class="keyword">null</span>;</span><br><span class="line">      buffer = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function">WritableComparable <span class="title">newKey</span><span class="params">()</span> </span>&#123;<span class="comment">//反射创建相应实例</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> ReflectionUtils.<span class="title">newInstance</span><span class="params">(keyClass, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="比较-1">比较</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">byte</span>[] b1, <span class="keyword">int</span> s1, <span class="keyword">int</span> l1, <span class="keyword">byte</span>[] b2, <span class="keyword">int</span> s2, <span class="keyword">int</span> l2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      buffer.reset(b1, s1, l1);                   <span class="comment">// parse key1</span></span><br><span class="line">      key1.readFields(buffer);<span class="comment">//反序列化b1为key1</span></span><br><span class="line">      </span><br><span class="line">      buffer.reset(b2, s2, l2);                   <span class="comment">// parse key2</span></span><br><span class="line">      key2.readFields(buffer);<span class="comment">//反序列化b2为key2</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">compare</span><span class="params">(key1, key2)</span></span>;                   <span class="comment">// compare them</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> a.<span class="title">compareTo</span><span class="params">(b)</span></span>;</span><br><span class="line">&#125;<span class="comment">//Comparable的比较方法</span></span><br></pre></td></tr></table></figure>
<p>如上，将byte数组分别反序列化为相应的WritableComparable，然后使用继承的Comparable方法进行比较<br>还提供了字节层面的字典序比较方法compareBytes<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">compareBytes</span><span class="params">(<span class="keyword">byte</span>[] b1, <span class="keyword">int</span> s1, <span class="keyword">int</span> l1, <span class="keyword">byte</span>[] b2, <span class="keyword">int</span> s2, <span class="keyword">int</span> l2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> end1 = s1 + l1;</span><br><span class="line">    <span class="keyword">int</span> end2 = s2 + l2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = s1, j = s2; i &lt; end1 &amp;&amp; j &lt; end2; i++, j++) &#123;</span><br><span class="line">      <span class="keyword">int</span> a = (b1[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">      <span class="keyword">int</span> b = (b2[j] &amp; <span class="number">0xff</span>);</span><br><span class="line">      <span class="keyword">if</span> (a != b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l1 - l2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Hadoop序列化框架">Hadoop序列化框架</h2><p>除了Java序列化和Hadoop中的Writable机制，还有其他序列化框架，如Hadoop Avro，Apache Thrift和Google Protocol Buffer等。<br>Hadoop提供了一个简单的序列化框架API，用于集成各种序列化实现，该框架由Serialization实现。<br>Serialization使用<code>抽象工厂</code>的设计模式，通过Serialization可以获得类型的Serializer实例，将一个对象转换为一个字节流的实现。也可以获得<br>Deserializer实例，将字节流转换为对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serialization</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">//判断序列化实现是否支持该类对象</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(Class&lt;?&gt; c)</span></span>;</span><br><span class="line">  <span class="comment">//获取序列化对象的Serializer实现</span></span><br><span class="line">  <span class="function">Serializer&lt;T&gt; <span class="title">getSerializer</span><span class="params">(Class&lt;T&gt; c)</span></span>;</span><br><span class="line">  <span class="comment">//获取反序列化对象的DeSerializer实现</span></span><br><span class="line">  <span class="function">Deserializer&lt;T&gt; <span class="title">getDeserializer</span><span class="params">(Class&lt;T&gt; c)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Serializer接口如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">//为序列化做准备</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">open</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="comment">//序列化对象到底层输出流</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">serialize</span><span class="params">(T t)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="comment">//关闭输出流，清理资源 </span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Deserializer接口如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Deserializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">//反序列化准备</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">open</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * &lt;p&gt;</span><br><span class="line">   * Deserialize the next object from the underlying input stream.</span><br><span class="line">   * If the object &lt;code&gt;t&lt;/code&gt; is non-null then this deserializer</span><br><span class="line">   * &lt;i&gt;may&lt;/i&gt; set its internal state to the next object read from the input</span><br><span class="line">   * stream. Otherwise, if the object &lt;code&gt;t&lt;/code&gt; is null a new</span><br><span class="line">   * deserialized object will be created.</span><br><span class="line">   * &lt;/p&gt;</span><br><span class="line">   * <span class="doctag">@return</span> the deserialized object</span><br><span class="line">   */</span></span><br><span class="line">  <span class="comment">//从底层输入流中反序列化下一个对象</span></span><br><span class="line">  <span class="function">T <span class="title">deserialize</span><span class="params">(T t)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//关闭底层输入流，清理资源</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目前Hadoop支持两个Serialization实现，分别是WritableSerialization(Writable机制)和Java序列化的JavaSerialization。<br>实现如下:<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> accept(<span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Writable.class.isAssignableFrom(c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Deserializer&lt;Writable&gt; getDeserializer(<span class="class"><span class="keyword">Class</span>&lt;<span class="title">Writable</span>&gt; <span class="title">c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WritableDeserializer(getConf(), c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Serializer&lt;Writable&gt; getSerializer(<span class="class"><span class="keyword">Class</span>&lt;<span class="title">Writable</span>&gt; <span class="title">c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WritableSerializer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而WritableSerializer如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WritableSerializer</span> <span class="keyword">implements</span> <span class="title">Serializer</span>&lt;<span class="title">Writable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DataOutputStream dataOut;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(OutputStream out)</span> </span>&#123;<span class="comment">//open时提供输出流</span></span><br><span class="line">      <span class="keyword">if</span> (out <span class="keyword">instanceof</span> DataOutputStream) &#123;</span><br><span class="line">        dataOut = (DataOutputStream) out;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dataOut = <span class="keyword">new</span> DataOutputStream(out);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Writable w)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      w.write(dataOut);<span class="comment">//实际序列化为Writable的write方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      dataOut.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>WritableDeserializer如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WritableDeserializer</span> <span class="keyword">extends</span> <span class="title">Configured</span>  <span class="keyword">implements</span> <span class="title">Deserializer</span>&lt;<span class="title">Writable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; writableClass;</span><br><span class="line">    <span class="keyword">private</span> DataInputStream dataIn;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WritableDeserializer</span><span class="params">(Configuration conf, Class&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">      setConf(conf);</span><br><span class="line">      <span class="keyword">this</span>.writableClass = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(InputStream in)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (in <span class="keyword">instanceof</span> DataInputStream) &#123;</span><br><span class="line">        dataIn = (DataInputStream) in;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dataIn = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Writable <span class="title">deserialize</span><span class="params">(Writable w)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      Writable writable;</span><br><span class="line">      <span class="keyword">if</span> (w == <span class="keyword">null</span>) &#123;<span class="comment">//null的话创建相应的实例</span></span><br><span class="line">        writable = (Writable) ReflectionUtils.newInstance(writableClass, getConf());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;<span class="comment">//非null使用w</span></span><br><span class="line">        writable = w;</span><br><span class="line">      &#125;</span><br><span class="line">      writable.readFields(dataIn);<span class="comment">//反序列化</span></span><br><span class="line">      <span class="keyword">return</span> writable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      dataIn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Common/" rel="tag">#Common</a>
          
            <a href="/tags/Hadoop-1-2-1/" rel="tag">#Hadoop-1.2.1</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/RPC源码分析下篇/" rel="next" title="RPC源码阅读---源码分析下篇">
                <i class="fa fa-chevron-left"></i> RPC源码阅读---源码分析下篇
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/RPC源码分析上篇/" rel="prev" title="RPC源码阅读---源码分析上篇">
                RPC源码阅读---源码分析上篇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="序列化/"
           data-title="Common源码阅读---序列化" data-url="http://xiao-yun.github.io/序列化/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/hero.jpg" alt="xiaoyun" itemprop="image"/>
          <p class="site-author-name" itemprop="name">xiaoyun</p>
        </div>
        <p class="site-description motion-element" itemprop="description">学习笔记，网上资源摘要等</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiao-yun" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JAVA中的序列化"><span class="nav-number">1.</span> <span class="nav-text">JAVA中的序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hadoop的序列化"><span class="nav-number">2.</span> <span class="nav-text">Hadoop的序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WritableComparable"><span class="nav-number">3.</span> <span class="nav-text">WritableComparable</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NullWritable"><span class="nav-number">3.1.</span> <span class="nav-text">NullWritable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ByteWritable"><span class="nav-number">3.2.</span> <span class="nav-text">ByteWritable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变长基本类型VIntWritable，VLongWritable"><span class="nav-number">3.3.</span> <span class="nav-text">变长基本类型VIntWritable，VLongWritable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#序列化"><span class="nav-number">3.3.1.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反序列化"><span class="nav-number">3.3.2.</span> <span class="nav-text">反序列化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Text"><span class="nav-number">3.4.</span> <span class="nav-text">Text</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#成员"><span class="nav-number">3.4.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编解码"><span class="nav-number">3.4.2.</span> <span class="nav-text">编解码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构造"><span class="nav-number">3.4.3.</span> <span class="nav-text">构造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据操作"><span class="nav-number">3.4.4.</span> <span class="nav-text">数据操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#序列化/反序列化"><span class="nav-number">3.4.5.</span> <span class="nav-text">序列化/反序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他一些高阶的序列化/反序列化操作"><span class="nav-number">3.4.6.</span> <span class="nav-text">其他一些高阶的序列化/反序列化操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#比较"><span class="nav-number">3.4.7.</span> <span class="nav-text">比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObjectWritable"><span class="nav-number">3.4.8.</span> <span class="nav-text">ObjectWritable</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#成员属性"><span class="nav-number">3.4.8.1.</span> <span class="nav-text">成员属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化-1"><span class="nav-number">3.4.8.2.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#反序列化-1"><span class="nav-number">3.4.8.3.</span> <span class="nav-text">反序列化</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WritableComparator"><span class="nav-number">4.</span> <span class="nav-text">WritableComparator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-1"><span class="nav-number">4.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构造-1"><span class="nav-number">4.2.</span> <span class="nav-text">构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#比较-1"><span class="nav-number">4.3.</span> <span class="nav-text">比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hadoop序列化框架"><span class="nav-number">5.</span> <span class="nav-text">Hadoop序列化框架</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaoyun</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xiaoyuncom"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
